"use strict";(()=>{var e={};e.id=139,e.ids=[139,538,456],e.modules={3524:e=>{e.exports=require("@prisma/client")},8432:e=>{e.exports=require("bcryptjs")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},5505:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{GET:()=>p,POST:()=>l});var a=r(9303),n=r(8716),o=r(670),i=r(7070),u=r(3538),c=r(5456);async function p(e){try{let{searchParams:t}=new URL(e.url),r=parseInt(t.get("page")||"1"),s=parseInt(t.get("limit")||"10"),a=t.get("search")||"",n=t.get("status")||"",o=t.get("paymentMethod")||"",c=t.get("startDate")||"",p=t.get("endDate")||"",l=(r-1)*s,d={};a&&(d.OR=[{saleNumber:{contains:a,mode:"insensitive"}},{customerName:{contains:a,mode:"insensitive"}},{customerEmail:{contains:a,mode:"insensitive"}},{customerPhone:{contains:a,mode:"insensitive"}}]),n&&(d.status=n),o&&(d.paymentMethod=o),c&&p&&(d.createdAt={gte:new Date(c),lte:new Date(p)});let[m,f]=await Promise.all([u.prisma.sale.findMany({where:d,include:{items:{include:{part:!0}},user:{select:{id:!0,name:!0,email:!0}}},orderBy:{createdAt:"desc"},skip:l,take:s}),u.prisma.sale.count({where:d})]);return i.NextResponse.json({success:!0,data:m,pagination:{page:r,limit:s,total:f,totalPages:Math.ceil(f/s)}})}catch(e){return console.error("Get sales error:",e),i.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function l(e){try{let t=e.cookies.get("auth-token")?.value;if(!t)return i.NextResponse.json({error:"Token de autentica\xe7\xe3o necess\xe1rio"},{status:401});let r=await (0,c.Sk)(t);if(!r)return i.NextResponse.json({error:"Token inv\xe1lido"},{status:401});let s=await e.json();if(!s.items||0===s.items.length)return i.NextResponse.json({error:"Pelo menos um item \xe9 necess\xe1rio"},{status:400});for(let e of s.items){let t=await u.prisma.part.findUnique({where:{id:e.partId}});if(!t)return i.NextResponse.json({error:`Pe\xe7a n\xe3o encontrada: ${e.partId}`},{status:404});if(t.stock<e.quantity)return i.NextResponse.json({error:`Estoque insuficiente para: ${t.name}`},{status:400})}let a=0,n=[];for(let e of s.items){let t=e.quantity*e.price-(e.discount||0);a+=t,n.push({partId:e.partId,quantity:e.quantity,price:parseFloat(e.price),discount:e.discount?parseFloat(e.discount):null,total:t})}s.discount&&(a-=parseFloat(s.discount));let o=function(){let e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),a=String(e.getTime()).slice(-6);return`${t}${r}${s}${a}`}(),p=await u.prisma.sale.create({data:{saleNumber:o,customerName:s.customerName,customerEmail:s.customerEmail,customerPhone:s.customerPhone,customerDocument:s.customerDocument,total:a,discount:s.discount?parseFloat(s.discount):null,paymentMethod:s.paymentMethod,notes:s.notes,userId:r.id,items:{create:n}},include:{items:{include:{part:!0}},user:{select:{id:!0,name:!0,email:!0}}}});for(let e of s.items)await u.prisma.part.update({where:{id:e.partId},data:{stock:{decrement:e.quantity}}}),await u.prisma.stockMovement.create({data:{partId:e.partId,type:"OUT",quantity:e.quantity,reason:"Venda",reference:p.saleNumber}});return i.NextResponse.json({success:!0,data:p})}catch(e){return console.error("Create sale error:",e),i.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sales/route",pathname:"/api/sales",filename:"route",bundlePath:"app/api/sales/route"},resolvedPagePath:"D:\\sistema-auto-pecas\\src\\app\\api\\sales\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:g}=d,h="/api/sales/route";function y(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},5456:(e,t,r)=>{r.d(t,{Sk:()=>d,c_:()=>c,generateToken:()=>l,verifyPassword:()=>p});var s=r(8432),a=r.n(s),n=r(1482),o=r.n(n),i=r(3538);let u=process.env.JWT_SECRET||"fallback-secret-key";async function c(e){return a().hash(e,12)}async function p(e,t){return a().compare(e,t)}function l(e){return o().sign({userId:e},u,{expiresIn:"7d"})}async function d(e){let t=function(e){try{return o().verify(e,u)}catch{return null}}(e);return t?await i.prisma.user.findUnique({where:{id:t.userId},select:{id:!0,email:!0,name:!0,role:!0}}):null}},3538:(e,t,r)=>{r.d(t,{prisma:()=>a});var s=r(3524);let a=globalThis.prisma??new s.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,972,482],()=>r(5505));module.exports=s})();